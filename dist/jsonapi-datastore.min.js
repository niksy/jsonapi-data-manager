"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),Model=function(){function t(e,i){_classCallCheck(this,t),this.id=i,this._type=e,this._attributes=[],this._dependents=[],this._relationships=[],this._links=this.links={},this._relationshipLinks={},this._meta=this.meta={},this._relationshipMeta={},this._destroyed=!1}return _createClass(t,[{key:"_addDependence",value:function(t,e,i){var a,n=this;a=n._dependents.find(function(a){return a.id===e&&a.type===t&&a.relation===i}),void 0===a&&n._dependents.push({id:e,type:t,relation:i})}},{key:"_removeDependence",value:function(t,e){var i=this;i._dependents.forEach(function(a,n){a.id===e&&a.type===t&&i._dependents.splice(n,1)})}},{key:"removeRelationship",value:function(t,e,i){var a=this;a._removeDependence(t,e),a[i].constructor===Array?a[i].forEach(function(n,s){n.id===e&&n.type===t&&a[i].splice(s,1)}):a[i].id===e&&(a[i]=null)}},{key:"serialize",value:function(t){var e=this,i={data:{type:this._type}};return t=t||{},t.attributes=t.attributes||this._attributes,t.relationships=t.relationships||this._relationships,t.links=t.links||void 0,t.meta=t.meta||void 0,void 0!==this.id&&(i.data.id=this.id),0!==t.attributes.length&&(i.data.attributes={}),0!==t.relationships.length&&(i.data.relationships={}),t.attributes.forEach(function(t){i.data.attributes[t]=e[t]}),t.relationships.forEach(function(t){function a(t){return{type:t._type,id:t.id}}e[t]?e[t].constructor===Array?i.data.relationships[t]={data:e[t].map(a)}:i.data.relationships[t]={data:a(e[t])}:i.data.relationships[t]={data:null},e._relationshipLinks[t]&&(i.data.relationships[t].links=e._relationshipLinks[t]),e._relationshipMeta[t]&&(i.data.relationships[t].meta=e._relationshipMeta[t])}),0!==Object.keys(this._links).length&&(void 0===t.links?i.data.links=this._links:t.links&&0!==t.links.length&&(i.data.links={},t.links.forEach(function(t){i.data.links[t]=e._links[t]}))),0!==Object.keys(this._meta).length&&(void 0===t.meta?i.data.meta=this._meta:t.meta&&0!==t.meta.length&&(i.data.meta={},t.meta.forEach(function(t){i.data.meta[t]=e._meta[t]}))),i}},{key:"setAttribute",value:function(t,e){void 0===this[t]&&this._attributes.push(t),this[t]=e}},{key:"setRelationship",value:function(t,e){void 0===this[t]&&this._relationships.push(t),this[t]=e}}]),t}(),Store=function(){function t(){_classCallCheck(this,t),this.graph={},this.order={}}return _createClass(t,[{key:"destroy",value:function(t){var e=this;t._destroyed=!0,t._dependents.forEach(function(i,a){e.graph[i.type][i.id].removeRelationship(t._type,t.id,i.relation)}),delete this.graph[t._type][t.id],this.order[t._type].splice(this.order[t._type].indexOf(t.id),1)}},{key:"find",value:function(t,e){return this.graph[t]&&this.graph[t][e]?this.graph[t][e]:null}},{key:"findAll",value:function(t){var e=this;return this.graph[t]?e.order[t].map(function(i){return e.graph[t][i]}):[]}},{key:"reset",value:function(){this.graph={},this.order={}}},{key:"initModel",value:function(t,e){this.graph[t]=this.graph[t]||{},this.order[t]=this.order[t]||[],this.graph[t][e]=this.graph[t][e]||new Model(t,e);var i=this.order[t].indexOf(e);return i===-1?this.order[t].push(e):(this.order[t].splice(i,1),this.order[t].push(e)),this.graph[t][e]}},{key:"syncRecord",value:function(t){function e(t){if(!a.find(t.type,t.id)){var e=a.initModel(t.type,t.id);e._placeHolder=!0}return a.graph[t.type][t.id]}var i,a=this,n=this.initModel(t.type,t.id);delete n._placeHolder;for(i in t.attributes)n._attributes.indexOf(i)===-1&&n._attributes.push(i),n[i]=t.attributes[i];if(t.links&&(n._links=n.links=t.links),t.meta&&(n._meta=n.meta=t.meta),t.relationships)for(i in t.relationships){var s=t.relationships[i];void 0!==s.data&&(n._relationships.indexOf(i)===-1&&n._relationships.push(i),null===s.data?n[i]=null:s.data.constructor===Array?(n[i]=s.data.map(e),n[i].forEach(function(t,e){t._addDependence(n._type,n.id,e)})):(n[i]=e(s.data),n[i]._addDependence(n._type,n.id,i))),s.links&&(n._relationshipLinks[i]=s.links),s.meta&&(n._relationshipMeta[i]=s.meta)}return n}},{key:"sync",value:function(t,e){var i=t.data,a=this.syncRecord.bind(this),e=e||{},n={};return e.topLevel=e.topLevel||!1,"meta"in t&&(n.meta=t.meta),"links"in t&&(n.links=t.links),"jsonapi"in t&&(n.jsonapi=t.jsonapi),t.errors?(n.errors=t.errors,n):i?(t.included&&t.included.map(a),n.data=i.constructor===Array?i.map(a):a(i),e.topLevel?n:n.data):[]}}]),t}();module.exports.Store=Store,module.exports.Model=Model;